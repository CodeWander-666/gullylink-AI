<!DOCTYPE html>
<html>
<head>
    <title>GullyLink - User</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .modal { display: none; position: fixed; bottom: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 1000; transition: transform 0.3s; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .menu-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .btn { background: #fc8019; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #status-toast { position: fixed; top: 10px; right: 10px; background: #333; color: white; padding: 10px; border-radius: 5px; display: none; z-index: 2000; }
    </style>
</head>
<body>

    <div id="status-toast"></div>
    <div id="map"></div>

    <div id="vendorModal" class="modal">
        <div class="modal-header" id="vName">Vendor Name</div>
        <div id="menuList"></div>
        <button onclick="closeModal()" style="margin-top:10px; width:100%; padding:10px;">Close</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Initialize Map (Centered on Delhi for dummy data)
        const map = L.map('map').setView([28.6139, 77.2090], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // User's Dummy Location
        const userLat = 28.6130;
        const userLng = 77.2095;
        L.marker([userLat, userLng]).addTo(map).bindPopup("You are here").openPopup();

        const markers = {};
        const ws = new WebSocket(`ws://${window.location.host}/ws`);

        // Load Vendors
        fetch('/api/vendors').then(res => res.json()).then(vendors => {
            for (let id in vendors) {
                updateMarker(vendors[id]);
            }
        });

        // Realtime Updates
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'location_update') {
                updateMarker(data);
            } else if (data.type === 'order_update') {
                showToast(`Order Status: ${data.status}`);
            }
        };

        function updateMarker(vendor) {
            // Create custom icon
            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:white; border:2px solid black; border-radius:50%; width:30px; height:30px; display:flex; justify-content:center; align-items:center; font-size:20px;'>${vendor.icon}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            if (markers[vendor.id]) {
                markers[vendor.id].setLatLng([vendor.lat, vendor.lng]);
            } else {
                const marker = L.marker([vendor.lat, vendor.lng], {icon: customIcon}).addTo(map);
                marker.on('click', () => openMenu(vendor));
                markers[vendor.id] = marker;
            }
        }

        function openMenu(vendor) {
            document.getElementById('vendorModal').style.display = 'block';
            document.getElementById('vName').innerText = vendor.name;
            const list = document.getElementById('menuList');
            list.innerHTML = 'Loading...';

            fetch(`/api/menu/${vendor.id}`).then(res => res.json()).then(menu => {
                list.innerHTML = '';
                menu.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'menu-item';
                    div.innerHTML = `
                        <span>${item.item} - ₹${item.price}</span>
                        <button class="btn" onclick="orderItem('${vendor.id}', '${item.item}')">Add</button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function orderItem(vendorId, item) {
            fetch('/api/order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    vendor_id: vendorId,
                    item: item,
                    customer_lat: userLat, 
                    customer_lng: userLng
                })
            }).then(res => res.json()).then(data => {
                showToast(`Ordered ${item}! Waiting for acceptance.`);
                closeModal();
            });
        }

        function closeModal() { document.getElementById('vendorModal').style.display = 'none'; }
        function showToast(msg) {
            const t = document.getElementById('status-toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
